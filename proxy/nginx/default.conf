# Set up the proxy cache path.
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m
               max_size=256m inactive=60m use_temp_path=off;

server {
  # Listen on port 18000.
  listen 18000;
  server_name localhost;

  # Initialize a variable to track cache-only mode.
  set $cache_only "0";

  location / {
    # Inspect incoming headers. If "X-Cached-Only" is set, mark cache-only mode.
    access_by_lua_block {
      local hdr = ngx.req.get_headers()["X-Cached-Only"]
      if hdr then
        ngx.var.cache_only = "1"
      else
        ngx.var.cache_only = "0"
      end
    }

    # Rewrite Location headers from the upstream.
    # Rewrites "https://www.w3.org/" to "http://localhost:18000/".
    proxy_redirect https://www.w3.org/ http://localhost:18000/;

    # Set Host header so that upstream sees "www.w3.org".
    proxy_set_header Host www.w3.org;

    # Proxy caching configuration.
    proxy_cache my_cache;
    proxy_cache_valid 200 1h;
    proxy_cache_use_stale error timeout updating http_500 http_502 
                           http_503 http_504;

    # Proxy the requests to the upstream defaulting to the www version.
    proxy_pass https://www.w3.org;
    proxy_ssl_server_name on;

    # After receiving the response, if in cache-only mode and the cached
    # response was a MISS, then return a 503 error.
    header_filter_by_lua_block {
      if ngx.var.cache_only == "1" then
        local status = ngx.var.upstream_cache_status or ""
        if status == "MISS" then
          ngx.status = 503
          ngx.header["Content-Type"] = "text/plain"
          ngx.say("Cached content not available")
          ngx.exit(503)
        end
      end
    }
  }
}
